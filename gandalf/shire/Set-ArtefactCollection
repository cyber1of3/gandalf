function Add-LogEntry { 
    Param ($ShowProgress, $OutputDirectory, $Hostname, $Artefact, $Message)
    $DateTime = Get-Date -Format yyyy-MM-ddTHH:mm:ss.fffffffZ
    "$DateTime, $Hostname, $Artefact, collected" | Add-Content $OutputDirectory\$Hostname\log.audit
    if ($ShowProgress -And $ShowProgress -ne "False") { 
        Write-Host "   -> $DateTime ->"$Message
    }
}

function Get-Artefacts { 
    Param ($ShowProgress, $Memory, $DriveLetter, $OutputDirectory, $Hostname)
    function Get-Volatile { 
        Param ($ShowProgress, $Memory, $OutputDirectory, $Hostname)
        function Get-Memory { 
            Param ($ShowProgress, $OutputDirectory, $Hostname)
            $global:ProgressPreference = "SilentlyContinue"
            $Architecture = Get-ComputerInfo | Select-Object OsArchitecture
            $Architecture = Out-String -InputObject $Architecture
            $Architecture = $Architecture -Replace '[\S\s]+(\d{2})-bit[\S\s]+', '$1'
            try { 
                Write-Progress "Acquiring raw memory dump from '$Hostname'..."
                if ($Architecture -eq "64") { 
                    $dumpit = { .\tools\DumpIt.exe /O .\$OutputDirectory\$Hostname\artefacts\artefacts\raw\memory\$Hostname.raw /C /N /Q }
                }
                else { 
                    $dumpit = { .\tools\DumpItx86.exe /O .\$OutputDirectory\$Hostname\artefacts\artefacts\raw\memory\$Hostname.raw /C /N /Q }
                }
                Invoke-Command -ScriptBlock $dumpit > $null 2>&1
                Write-Host "       Acquired raw memory dump from '$Hostname'" -ForegroundColor Green
                $Message = "acquired live memory dump (raw) from '$Hostname'"
                Add-LogEntry $ShowProgress $OutputDirectory $Hostname "$Hostname.raw" $Message
            }
            catch { 
                Write-Host "      FAILURE: memory dump could not be collected." -ForegroundColor Red
            }
            $global:ProgressPreference = "Continue"
        }
        function Get-SystemInfo { 
            Param ($ShowProgress, $OutputDirectory, $Hostname)
            try { 
                Write-Progress "Acquiring system information from '$Hostname'..."
                $global:ProgressPreference = "SilentlyContinue"
                Get-ComputerInfo | Select-Object WindowsInstallationType, WindowsInstallDateFromRegistry, WindowsProductName, WindowsRegisteredOwner, WindowsSystemRoot, BiosBIOSVersion, CsDaylightInEffect, CsDNSHostName, CsDomain, CsHypervisorPresent, CsManufacturer, CsModel, CsNetworkAdapters, CsProcessors, CsRoles, CsSystemType, CsTotalPhysicalMemory, CsUserName, OsName, OsBootDevice, OsSystemDirectory, OsWindowsDirectory, OsLocale, OsLocalDateTime, OsLastBootUpTime, OsUptime, OsArchitecture, OsLanguage, OsProductType, KeyboardLayout, TimeZone, LogonServer, PowerPlatformRole | Set-Content $OutputDirectory\$Hostname\artefacts\artefacts\system.csv
                $global:ProgressPreference = "Continue"
                Write-Host "       Acquired system information from '$Hostname'" -ForegroundColor Green
                $Message = "acquired live system information from '$Hostname'"
                Add-LogEntry $ShowProgress $OutputDirectory $Hostname "system_information(live)" $Message
            }
            catch { 
                Write-Host "      FAILURE: system information could not be collected; another process may be using the same resources." -ForegroundColor Red
            }
        }
        function Get-Processes { 
            Param ($ShowProgress, $OutputDirectory, $Hostname)
            try { 
                Write-Progress "Acquiring process information from '$Hostname'..."
                Get-CimInstance -ClassName Win32_Process | Select-Object ProcessId, Name, HandleCount | Export-Csv -Path $OutputDirectory\$Hostname\artefacts\artefacts\processes.csv -NoTypeInformation
                (Get-Content -Path $OutputDirectory\$Hostname\artefacts\artefacts\processes.csv) -Replace '"(\d+)"(,")([^"]+",)"(\d+)"', '$1$2$3$4' | Set-Content $OutputDirectory\$Hostname\artefacts\artefacts\processes.csv
                Write-Host "       Acquired process information from '$Hostname'" -ForegroundColor Green
                $Message = "acquired live process information from '$Hostname'"
                Add-LogEntry $ShowProgress $OutputDirectory $Hostname "running_processes(live)" $Message
            }
            catch { 
                Write-Host "      FAILURE: process information could not be collected; another process may be using the same resources." -ForegroundColor Red
            }
        }
        function Get-Drivers { 
            Param ($ShowProgress, $OutputDirectory, $Hostname)
            try { 
                Write-Progress "Acquiring driver information from '$Hostname'..."
                Get-CimInstance -ClassName Win32_SystemDriver | Select-Object DisplayName, Name, State, Status, Started | Export-Csv -Path $OutputDirectory\$Hostname\artefacts\artefacts\drivers.csv -NoTypeInformation
                (Get-Content -Path $OutputDirectory\$Hostname\artefacts\artefacts\drivers.csv) -Replace ',"([^"]+)","([^"]+)","([^"]+)","([^"]+)', ',$1,$2,$3,$4' | Set-Content $OutputDirectory\$Hostname\artefacts\artefacts\drivers.csv
                Write-Host "       Acquired driver information from '$Hostname'" -ForegroundColor Green
                $Message = "acquired live driver information from '$Hostname'"
                Add-LogEntry $ShowProgress $OutputDirectory $Hostname "installed_drivers(live)" $Message
            }
            catch { 
                Write-Host "      FAILURE: driver information could not be collected; another process may be using the same resources." -ForegroundColor Red
            }
        }
        function Get-Services { 
            Param ($ShowProgress, $OutputDirectory, $Hostname)
            try { 
                Write-Progress "Acquiring service information from '$Hostname'..."
                Get-WmiObject Win32_Service | Select-Object ProcessId, Name, State, Status, StartMode, ExitCode | Export-Csv $OutputDirectory\$Hostname\artefacts\artefacts\services.csv -NoTypeInformation
                (Get-Content -Path $OutputDirectory\$Hostname\artefacts\artefacts\services.csv) -Replace '"', '' | Set-Content $OutputDirectory\$Hostname\artefacts\artefacts\services.csv
                Write-Host "       Acquired service information from '$Hostname'" -ForegroundColor Green
                $Message = "acquired live service information from '$Hostname'"
                Add-LogEntry $ShowProgress $OutputDirectory $Hostname "installed_services(live)" $Message
            }
            catch { 
                Write-Host "      FAILURE: service information could not be collected; another process may be using the same resources." -ForegroundColor Red
            }
        }
        function Get-Network { 
            Param ($ShowProgress, $OutputDirectory, $Hostname)
            try { 
                Write-Progress "Acquiring network information from '$Hostname'..."
                Get-NetTCPConnection | Select-Object CreationTime, State, LocalAddress, LocalPort, RemoteAddress, RemotePort, OwningProcess, Name, InstallDate, EnabledDefault, AppliedSetting, Status | Export-Csv -Path $OutputDirectory\$Hostname\artefacts\artefacts\network.csv -NoTypeInformation
                (Get-Content -Path $OutputDirectory\$Hostname\artefacts\artefacts\network.csv) -Replace '"', '' | Set-Content $OutputDirectory\$Hostname\artefacts\artefacts\network.csv
                Write-Host "       Acquired network information from '$Hostname'" -ForegroundColor Green
                $Message = "acquired live network configuration from '$Hostname'"
                Add-LogEntry $ShowProgress $OutputDirectory $Hostname "network_configuration(live)" $Message
            }
            catch { 
                Write-Host "      FAILURE: network information could not be collected; another process may be using the same resources." -ForegroundColor Red
            }
        }
        function Get-Tasks { 
            Param ($ShowProgress, $OutputDirectory, $Hostname)
            try { 
                Write-Progress "Acquiring scheduled task information from '$Hostname'..."
                $schtasks = 
                { 
                    schtasks.exe /query /V /FO CSV | ConvertFrom-Csv | Where-Object { $_.TaskName -ne "TaskName" }
                } 
                Invoke-Command -ScriptBlock $schtasks | Select-Object "Last Run Time", "Next Run Time", TaskName, Status, "Logon Mode", Author, "Task To Run", "Scheduled Task State", "Run As User", "Schedule Type", Days | Export-Csv $OutputDirectory\$Hostname\artefacts\artefacts\tasks.csv
                (Get-Content -Path $OutputDirectory\$Hostname\artefacts\artefacts\tasks.csv) -Replace '"([^"]+)","([^"]+)"(,"[^"]+",)"([^"]+)","([^"]+)"(,"[^"]+","[^"]+",)"([^"]+)","([^"]+)"(,"[^"]+",)"([^"]+)"', '$1,$2$3$4,$5$6$7,$8$9$10' | Set-Content $OutputDirectory\$Hostname\artefacts\artefacts\tasks.csv
                Write-Host "       Acquired scheduled task information from '$Hostname'" -ForegroundColor Green
                $Message = "acquired live scheduled tasks from '$Hostname'"
                Add-LogEntry $ShowProgress $OutputDirectory $Hostname "scheduled_tasks(live)" $Message
            }
            catch { 
                Write-Host "      FAILURE: scheduled task information could not be collected; another process may be using the same resources." -ForegroundColor Red
            }
        }
        if ($Memory -And $Memory -ne "False") { 
            Get-Memory $ShowProgress $OutputDirectory $Hostname
        }
        Get-SystemInfo $ShowProgress $OutputDirectory $Hostname
        Get-Processes $ShowProgress $OutputDirectory $Hostname
        Get-Drivers $ShowProgress $OutputDirectory $Hostname
        Get-Services $ShowProgress $OutputDirectory $Hostname
        Get-Network $ShowProgress $OutputDirectory $Hostname
        Get-Tasks $ShowProgress $OutputDirectory $Hostname
    }
    function Get-Core { 
        Param ($ShowProgress, $DriveLetter, $OutputDirectory, $Hostname)
        Write-Progress "Acquiring `$MFT from '$Hostname'..."
        $global:ProgressPreference = "SilentlyContinue"
        Expand-Archive -LiteralPath "$OutputDirectory\tools\icat-sk-4.11.1-win32.zip" -DestinationPath "$OutputDirectory\tools\icat"
        $icat = { C:\TEMP\gandalf\gandalf\tools\icat\bin\icat.exe \\.\c: 0 > $OutputDirectory\$Hostname\artefacts\artefacts\raw\`$MFT }
        Invoke-Command -ScriptBlock $icat
        Remove-Item "$OutputDirectory\tools\icat" -Recurse -Force
        $global:ProgressPreference = "Continue"
        Write-Host "       Acquired `$MFT from '$Hostname'" -ForegroundColor Green
        $Message = "acquired '$ArtefactFile' from '$Hostname'"
        Add-LogEntry $ShowProgress $OutputDirectory $Hostname $ArtefactFile $Message
        $Artefacts = @("hiberfil.sys", "pagefile.sys", "Windows\AppCompat\Programs\Amcache.hve", "Windows\INF\setupapi.dev.log")
        ForEach ($Artefact in $Artefacts) { 
            $ArtefactFile = $Artefact.Split("\\")[-1]
            Write-Progress "Acquiring $ArtefactFile from '$Hostname'..."
            try { 
                Copy-Item $DriveLetter\$Artefact -Destination $OutputDirectory\$Hostname\artefacts\arefacts\raw\ -Force -ErrorAction SilentlyContinue
                $Message = "acquired '$ArtefactFile' from '$Hostname'"
                Add-LogEntry $ShowProgress $OutputDirectory $Hostname $Artefact $Message
            }
            catch { 
                Write-Host "      FAILURE: $DriveLetter\$Artefact could not be collected; it may be being used by another process." -ForegroundColor Red
            }
        }
    }
    function Get-Wmi { 
        Param ($ShowProgress, $DriveLetter, $OutputDirectory, $Hostname)
        $Wmis = @("$DriveLetter\Windows\System32\wbem\Repository\")
        Write-Progress "Acquiring WMI evidence from '$Hostname'..."
        ForEach ($Wmi in Get-ChildItem -Path $Wmis -ErrorAction SilentlyContinue -ErrorVariable PermissionDenied) { 
            if ($Wmi.FullName.Endswith("OBJECTS.DATA") -Or $Wmi.FullName.Endswith("INDEX.BTR") -Or $Wmi.FullName.Endswith(".MAP")) { 
                try { 
                    Copy-Item $Wmi.FullName -Destination $OutputDirectory\$Hostname\artefacts\artefacts\raw\wmi -Force -ErrorAction SilentlyContinue
                    $Message = "acquired '$Wmi' WMI evidence from '$Hostname'"
                    Add-LogEntry $ShowProgress $OutputDirectory $Hostname $Wmi $Message
                }
                catch { 
                    Write-Host "      FAILURE: WMI artefacts could not be collected; they may be being used by another process." -ForegroundColor Red
                }
            }
        }
        $Wmis = @("$DriveLetter\Windows\System32\wbem\AutoRecover\")
        ForEach ($Wmi in Get-ChildItem -Path $Wmis -ErrorAction SilentlyContinue -ErrorVariable PermissionDenied) { 
            if ($Wmi.FullName.Endswith(".MOF") -Or $Wmi.FullName.Endswith(".mof")) { 
                try { 
                    Copy-Item $Wmi.FullName -Destination $OutputDirectory\$Hostname\artefacts\artefacts\raw\wmi -Force -ErrorAction SilentlyContinue
                    Add-LogEntry $ShowProgress $OutputDirectory $Hostname $Wmi $Message
                }
                catch { 
                    Write-Host "      FAILURE: WMI artefacts could not be collected; they may be being used by another process." -ForegroundColor Red
                }
            }
        }
        Write-Host "       Acquired WMI evidence from '$Hostname'" -ForegroundColor Green
    }
    function Get-Registry { 
        Param ($ShowProgress, $OutputDirectory, $Hostname)
        $Hives = @("SAM", "SECURITY", "SOFTWARE", "SYSTEM")
        try { 
            Write-Progress "Acquiring registry hives from '$Hostname'..."
            ForEach ($Hive in $Hives) { 
                try { 
                    reg save "HKLM\$Hive" "$OutputDirectory\$Hostname\artefacts\artefacts\raw\registry\$Hive" /y > $null
                    $Message = "acquired '$Hive' registry hive from '$Hostname'"
                    Add-LogEntry $ShowProgress $OutputDirectory $Hostname $Hive $Message
                }
                catch { 
                    Write-Host "      FAILURE: "HKLM\$Hive" could not be collected; they may be being used by another process." -ForegroundColor Red
                }
            }
            ForEach ($SidPath in reg query "HKU") { 
                $Sid = $SidPath.Split('\')[-1]
                if ($Sid.Startswith("S-") -And -Not $Sid.Endswith("_Classes")) { 
                    try { 
                        reg save "$SidPath" "$OutputDirectory\$Hostname\artefacts\artefacts\raw\registry\$Sid+NTUSER.DAT" /y > $null
                        $Message = "acquired 'NTUSER.DAT' ($Sid) registry hive from '$Hostname'"
                        Add-LogEntry $ShowProgress $OutputDirectory $Hostname "NTUSER.DAT ($Sid)" $Message
                    }
                    catch { 
                        Write-Host "      FAILURE: "SidPath" NTUSER.DAT could not be collected; they may be being used by another process." -ForegroundColor Red
                    }
                }
            }
            ForEach ($SidPath in reg query "HKU") { 
                $Sid = $SidPath.Split('\')[-1]
                if ($Sid.Endswith("_Classes")) { 
                    try { 
                        reg save "$SidPath" "$OutputDirectory\$Hostname\artefacts\artefacts\raw\registry\$Sid+UsrClass.DAT" /y > $null
                        $Message = "acquired 'UsrClass.DAT' ($Sid) registry hive from '$Hostname'"
                        Add-LogEntry $ShowProgress $OutputDirectory $Hostname "UsrClass.DAT ($Sid)" $Message
                    }
                    catch { 
                        Write-Host "      FAILURE: "SidPath" UsrClass.DAT could not be collected; they may be being used by another process." -ForegroundColor Red
                    }
                }
            }
            Write-Host "       Acquired registry hives from '$Hostname'" -ForegroundColor Green
        }
        catch { 
            Write-Host "      FAILURE: registry hives could not be collected; they may be being used by another process." -ForegroundColor Red
        }
    }
    function Get-Winevt { 
        Param ($ShowProgress, $DriveLetter, $OutputDirectory, $Hostname)
        $Evts = @("$DriveLetter\Windows\System32\Winevt\Logs\")
        try { 
            Write-Progress "Acquiring windows event logs from '$Hostname'..."
            ForEach ($Evt in Get-ChildItem -Path $Evts -ErrorAction SilentlyContinue -ErrorVariable PermissionDenied) { 
                if ($Evt.FullName.Endswith(".evtx")) { 
                    try { 
                        Copy-Item $Evt.FullName -Destination $OutputDirectory\$Hostname\artefacts\artefacts\raw\evt -Force -ErrorAction SilentlyContinue
                        $Message = "acquired '$Evt' event log from '$Hostname'"
                        Add-LogEntry $ShowProgress $OutputDirectory $Hostname $Evt $Message
                    }
                    catch { 
                        Write-Host "      FAILURE: '$Evt' could not be collected; it may be being used by another process." -ForegroundColor Red
                    }
                }
            }
            Write-Host "       Acquired windows event logs from '$Hostname'" -ForegroundColor Green
        }
        catch { 
            Write-Host "      FAILURE: windows event logs could not be collected; they may be being used by another process." -ForegroundColor Red
        }
    }
    function Get-Prefetch { 
        Param ($ShowProgress, $DriveLetter, $OutputDirectory, $Hostname)
        $Prefetch = @("$DriveLetter\Windows\Prefetch\")
        try { 
            Write-Progress "Acquiring prefetch files from '$Hostname'..."
            ForEach ($Pf in Get-ChildItem -Path $Prefetch -ErrorAction SilentlyContinue -ErrorVariable PermissionDenied) { 
                if ($Pf.FullName.Endswith(".pf")) { 
                    try { 
                        Copy-Item $Pf.FullName -Destination $OutputDirectory\$Hostname\artefacts\artefacts\raw\prefetch -Force -ErrorAction SilentlyContinue
                        $Message = "acquired '$Pf' prefetch file from '$Hostname'"
                        Add-LogEntry $ShowProgress $OutputDirectory $Hostname $Pf $Message
                    }
                    catch { 
                        Write-Host "      FAILURE: '$Pf' could not be collected; it may be being used by another process." -ForegroundColor Red
                    }
                }
            }
            Write-Host "       Acquired prefetch files from '$Hostname'" -ForegroundColor Green
        }
        catch { 
            Write-Host "      FAILURE: prefetch files could not be collected; they may be being used by another process." -ForegroundColor Red
        }
    }
    function Get-Users { 
        Param ($ShowProgress, $DriveLetter, $OutputDirectory, $Hostname)
        function Get-Jumplists { 
            Param ($ShowProgress, $OutputDirectory, $Hostname, $UserDirs)
            try { 
                ForEach ($User in Get-ChildItem -Path $UserDirs -ErrorAction SilentlyContinue -ErrorVariable PermissionDenied) { 
                    Write-Progress "Acquiring jumplists for '$User' from '$Hostname'..."
                    ForEach ($UserArtefact in Get-ChildItem -Path $User.FullName -Force -Recurse -ErrorAction SilentlyContinue -ErrorVariable PermissionDenied) { 
                        if ($UserArtefact.FullName.Contains("AppData\Roaming\Microsoft\Windows\Recent\AutomaticDestinations\") -Or $UserArtefact.FullName.Contains("AppData\Roaming\Microsoft\Windows\Recent\CustomDestinations\")) { 
                            try { 
                                Copy-Item $UserArtefact.FullName -Destination "$OutputDirectory\$Hostname\artefacts\artefacts\raw\jumplists\$User+$UserArtefact" -Force -ErrorAction SilentlyContinue
                                $Message = "acquired jumplist file '$UserArtefact' for '$User' from '$Hostname'"
                                Add-LogEntry $ShowProgress $OutputDirectory $Hostname $UserArtefact $Message
                            }
                            catch { 
                                Write-Host "      FAILURE: '$UserArtefact' for '$User' could not be collected; it may be being used by another process." -ForegroundColor Red
                            }
                        }
                    }
                    $JumplistFiles = Get-ChildItem $OutputDirectory\$Hostname\artefacts\artefacts\raw\jumplists
                    $User = [convert]::ToString($User)
                    if (Select-String -InputObject $JumplistFiles -Pattern $User) { 
                        Write-Host "       Acquired jumplist evidence for '$User' from '$Hostname'" -ForegroundColor Green
                    }
                }
            }
            catch { 
                Write-Host "      FAILURE: '$User' jumplists files could not be collected; they may be being used by another process." -ForegroundColor Red
            }
        }
        function Get-Browsers { 
            Param ($ShowProgress, $DriveLetter, $Hostname, $UserDirs)
            try { 
                ForEach ($User in Get-ChildItem -Path $UserDirs -ErrorAction SilentlyContinue -ErrorVariable PermissionDenied) { 
                    Write-Progress "Acquiring browser artefacts for '$User' from '$Hostname'..."
                    ForEach ($UserArtefact in Get-ChildItem -Path $User.FullName -Force -Recurse -ErrorAction SilentlyContinue -ErrorVariable PermissionDenied) { 
                        if ($UserArtefact.FullName.Endswith("AppData\Local\Microsoft\Edge\User Data\Default\History")) { 
                            try { 
                                Copy-Item $UserArtefact.FullName -Destination $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers\edge\$User+$UserArtefact -Force -ErrorAction SilentlyContinue
                                $Message = "acquired edge browser history for '$User' from '$Hostname'"
                                Add-LogEntry $ShowProgress $OutputDirectory $Hostname $UserArtefact $Message
                            }
                            catch { 
                                Write-Host "      FAILURE: '$UserArtefact' for '$User' could not be collected; it may be being used by another process." -ForegroundColor Red
                            }
                            $BrowserFiles = (Get-ChildItem $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers\edge | Measure-Object).Count
                            $BrowserFiles = [convert]::ToInt32($BrowserFiles)
                            if ($BrowserFiles -ne 0) { 
                                Write-Host "       Acquired edge browser history evidence for '$User' from '$Hostname'" -ForegroundColor Green
                            }
                        }
                        if ($UserArtefact.FullName.Endswith("AppData\Local\Google\Chrome\User Data\Default\History")) { 
                            try { 
                                Copy-Item $UserArtefact.FullName -Destination $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers\chrome\$User+$UserArtefact -Force -ErrorAction SilentlyContinue
                                $Message = "acquired chrome browser history for '$User' from '$Hostname'"
                                Add-LogEntry $ShowProgress $OutputDirectory $Hostname $UserArtefact $Message
                            }
                            catch { 
                                Write-Host "      FAILURE: '$UserArtefact' for '$User' could not be collected; it may be being used by another process." -ForegroundColor Red
                            }
                            $BrowserFiles = (Get-ChildItem $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers\chrome | Measure-Object).Count
                            $BrowserFiles = [convert]::ToInt32($BrowserFiles)
                            if ($BrowserFiles -ne 0) { 
                                Write-Host "       Acquired chrome browser history evidence for '$User' from '$Hostname'" -ForegroundColor Green
                            }
                        }
                        if ($UserArtefact.FullName.Endswith("AppData\Roaming\Mozilla\Firefox\Profiles\")) { 
                            # need to copy folder from this location
                            try {
                                Copy-Item $UserArtefact.FullName -Destination $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers\firefox\$User+$UserArtefact -Force -ErrorAction SilentlyContinue
                                $Message = "acquired firefox browser history for '$User' from '$Hostname'"
                                Add-LogEntry $ShowProgress $OutputDirectory $Hostname $UserArtefact $Message
                            }
                            catch {
                                Write-Host "      FAILURE: '$UserArtefact' for '$User' could not be collected; it may be being used by another process." -ForegroundColor Red
                            }
                            $BrowserFiles = (Get-ChildItem $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers\firefox | Measure-Object).Count
                            $BrowserFiles = [convert]::ToInt32($BrowserFiles)
                            if ($BrowserFiles -ne 0) {
                                Write-Host "       Acquired firefox browser history evidence for '$User' from '$Hostname'" -ForegroundColor Green
                            }
                        }
                    }
                }
            }
            catch {
                Write-Host "      FAILURE: '$User' browser files could not be collected; they may be being used by another process." -ForegroundColor Red
            }
        }
        $UserDirs = @("$DriveLetter\Users\")
        Get-Jumplists $ShowProgress $OutputDirectory $Hostname $UserDirs
        Get-Browsers $ShowProgress $OutputDirectory $Hostname $UserDirs
    }
    Get-Volatile $ShowProgress $Memory $OutputDirectory $Hostname
    Get-Core $ShowProgress $DriveLetter $OutputDirectory $Hostname
    Get-Wmi $ShowProgress $DriveLetter $OutputDirectory $Hostname
    Get-Registry $ShowProgress $OutputDirectory $Hostname
    Get-Winevt $ShowProgress $DriveLetter $OutputDirectory $Hostname
    Get-Prefetch $ShowProgress $DriveLetter $OutputDirectory $Hostname
    Get-Users $ShowProgress $DriveLetter $OutputDirectory $Hostname
    Write-Progress -Activity "_" -Completed
}

function Get-Metadata {
    #$DateTime = "{0:o}" -f (Get-Date)
    $FileHash = Get-FileHash -Algorithm SHA256 $Artefact
    "$Hostname,$FileHash`n" | Set-Content $OutputDirectory\$Hostname\log.audit
}

function Get-Platform {
    Param ($ShowProgress, $DriveLetter, $OutputDirectory, $Hostname)
    if ((Get-ChildItem "$DriveLetter\").Name | Select-String -Pattern "MSOCache") {
        $Platform = "Windows7"
    }
    else {
        $Platform = "Windows10"
    }
    "$Hostname::$Platform
" | Set-Content $OutputDirectory\$Hostname\artefacts\artefacts\raw\host.info
    Write-Host "       Identified '$Hostname' as '$Platform'" -ForegroundColor White
    $Message = "identified '$Hostname' as $Platform"
    Add-LogEntry $ShowProgress $OutputDirectory $Hostname $Platform $Message
}

function Optimize-Archive {
    Param ($OutputDirectory, $Hostname)
    function Remove-Directories {
        Param ($OutputDirectory, $Hostname)
        $EmptyDirectories = @()
        ForEach ($SubDirectory in Get-ChildItem -Force -Literal $OutputDirectory\$Hostname -Directory) {
            $SubFiles = (Get-ChildItem $OutputDirectory\$Hostname\$SubDirectory | Measure-Object).Count
            $SubFiles = [convert]::ToInt32($SubFiles)
            if ($SubFiles -eq 0) {
                $EmptyDirectories += , $SubDirectory.FullName
            }
            else {
                $SubDirectory = [convert]::ToString($SubDirectory)
                if ($SubDirectory -eq "browsers") {
                    ForEach ($BrowserDirectory in Get-ChildItem -Force -Literal $OutputDirectory\$Hostname\$SubDirectory -Directory) {
                        $BrowserFiles = (Get-ChildItem $OutputDirectory\$Hostname\$SubDirectory\$BrowserDirectory | Measure-Object).Count
                        $BrowserFiles = [convert]::ToInt32($BrowserFiles)
                        if ($BrowserFiles -eq 0) {
                            $EmptyDirectories += , $BrowserDirectory.FullName
                        }
                    }
                }
            }
        }
        ForEach ($EachDirectory in $EmptyDirectories) {
            Remove-Item -Path $EachDirectory > $null
        }
    }
    Remove-Directories $OutputDirectory $Hostname # remove empty artefact directories
    Remove-Directories $OutputDirectory $Hostname # remove empty browser artefact directories
    $Result = (Get-ChildItem $OutputDirectory\$Hostname | Measure-Object).Count
    $Result = [convert]::ToInt32($Result)
    return $Result
}

function New-Archive {
    Param ($EncryptionObject, $OutputDirectory, $ShowProgress, $Hostname, $Message, $ArchiveObject)
    Write-Host `r
    $SourcePath = Resolve-Path -Path $OutputDirectory\$Hostname\artefacts
    $ArchivePath = Resolve-Path -Path $OutputDirectory\$Hostname
    if ($EncryptionObject -eq "None") {
        $ArchiveFile = Join-Path -Path $ArchivePath -ChildPath "$Hostname.zip"
        if (Test-Path -LiteralPath $ArchiveFile) {
            Remove-Item -Path $ArchiveFile -Recurse > $null
        }
        Compress-Archive -Path $SourcePath -DestinationPath $ArchiveFile
    }
    elseif ($EncryptionObject -eq "Key") {
        $ArchiveFile = Join-Path -Path $ArchivePath -ChildPath "$Hostname.zip"
        if (Test-Path -LiteralPath $ArchiveFile) {
            Remove-Item -Path $ArchiveFile -Recurse > $null
        }
        Compress-7Zip -Path $SourcePath -ArchiveFileName $ArchiveFile -Format Zip
    }
    else {
        $ArchiveFile = Join-Path -Path $ArchivePath -ChildPath "$Hostname.7z"
        if (Test-Path -LiteralPath $ArchiveFile) {
            Remove-Item -Path $ArchiveFile -Recurse > $null
        }
        $ArchiveObject = [Runtime.InteropServices.Marshal]::SecureStringToBSTR($ArchiveObject)
        $ArchiveObject = [Runtime.InteropServices.Marshal]::PtrToStringBSTR($ArchiveObject)
        Compress-7Zip -Path $SourcePath -ArchiveFileName $ArchiveFile -Format SevenZip -Password $ArchiveObject -EncryptFilenames
    }
    $ArchiveFile = $ArchiveFile.Split("\\")[-1]
    Write-Host "       Successfully created '$ArchiveFile'" -ForegroundColor White
    $Message = "archived artefacts from '$Hostname'"
    Add-LogEntry $ShowProgress $OutputDirectory $Hostname $ArchiveFile $Message
}

function New-Directories {
    Param ($OutputDirectory, $Hostname)
    $DriveLetter = $env:SystemDrive
    New-Item -Path $OutputDirectory\$Hostname -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\wmi -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\memory -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\registry -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\evt -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\prefetch -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\jumplists -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers\edge -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers\chrome -ItemType Directory > $null; New-Item -Path $OutputDirectory\$Hostname\artefacts\artefacts\raw\browsers\firefox -ItemType Directory > $null
    return $DriveLetter
}

function Invoke-LocalSession {
    Param ($EncryptionObject, $OutputDirectory, $ShowProgress, $Memory, $Hostname, $ArchiveObject)
    $DriveLetter = New-Directories $OutputDirectory $Hostname
    "LastWriteTime,gandalf_host,gandalf_stage,gandalf_log_entry" | Set-Content $OutputDirectory\$Hostname\log.audit
    Write-Host "`n  -> Commencing artefact acquisition for: '$Hostname'`n    ----------------------------------------" -Foreground Gray
    $Message = "commencing artefact acquisition from '$Hostname'"
    Add-LogEntry $ShowProgress $OutputDirectory $Hostname "acquisition_commenced" $Message
    Get-Platform $ShowProgress $DriveLetter $OutputDirectory $Hostname
    Get-Artefacts $ShowProgress $Memory $DriveLetter $OutputDirectory $Hostname
    $Result = Optimize-Archive $OutputDirectory $Hostname
    if ($Result -gt 0) {
        New-Archive $EncryptionObject $OutputDirectory $ShowProgress $Hostname $Message $ArchiveObject
    }
    else {
        Write-Host "`n    Unfortunately, no artefacts could be collected`n`n"
        Exit
    }
}

Invoke-LocalSession $EncryptionObject $OutputDirectory $ShowProgress $Memory $Hostname $ArchiveObject